<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nidas.app.product.mapper.ProductMapper">

<select id="selectProdCnt" parameterType="com.nidas.app.product.vo.ProductVO" resultType="int">

<!-- 페이징 검색 결과 수 쿼리 -->

select count(*)
from V_NOWONSALE a
where 1=1  
<if test='pCategory != null and pCategory != ""'>
and pCategory = #{pCategory}
</if>
<if test='search != null and search != ""'>
and (pnamekor like '%'||#{search}||'%' or upper(pnameEng) like upper('%'||#{search}||'%') or bnamekor like '%'||#{search}||'%' or upper(pnameEng) like upper('%'||#{search}||'%') )
</if>
	<if test='brands != null'> 
and brand in
	<foreach collection="brands" item="br" open="(" close=")" separator=",">
	#{br}
	</foreach>
</if>
<if test='colors != null'>
and color in
	<foreach collection="colors" item="co" open="(" close=")" separator=",">
	#{co}
	</foreach>
</if>
<if test='sizes != null'>
and
	<foreach collection="sizes" item="si" open="(" close=")" separator="or">
	${si} != 0 
	</foreach>
</if>
</select>

<!-- 페이징 쿼리 -->
<select id="selectProdList" parameterType="com.nidas.app.product.vo.ProductVO" resultType="com.nidas.app.product.vo.ProductVO">

/* 제일 안쪽 셀렉트 쿼리에서 모든 요소를 필터하고 정렬하며, 바깥쪽의 두 셀렉트는 순전히 rn 표시를 하기 위한 쿼리임 */  

select *
from
  (select inv.*, rownum as rn
  from
    (select v.*, price*(1-nvl(disrate, 0)) as disPrice
    from V_NOWONSALE v
    where 1=1
	<if test='pCategory != null and pCategory != ""'>
	and pCategory = #{pCategory}
	</if>
	<if test='search != null and search != ""'>
	and (pnamekor like '%'||#{search}||'%' or upper(pnameEng) like upper('%'||#{search}||'%') or bnamekor like '%'||#{search}||'%' or upper(pnameEng) like upper('%'||#{search}||'%') )
	</if>
 	<if test="brands != null"> 
	and brand in
		<foreach collection="brands" item="br" open="(" close=")" separator=",">
		#{br}
		</foreach>
	</if>
	<if test="colors != null">
	and color in
		<foreach collection="colors" item="co" open="(" close=")" separator=",">
		#{co}
		</foreach>
	</if>
	<if test="sizes != null">
	and
		<foreach collection="sizes" item="si" open="(" close=")" separator="or">
		${si} != 0 
		</foreach>
	</if>  
    order by reldate desc) inv
  order by rn)
where rn between #{pageStart} and #{pageEnd}


</select>


<!-- 라인코드 쿼리 -->
<select id="selectSameLine" parameterType="String" resultType="com.nidas.app.product.vo.ProductVO">
select * from product where stylecode = (select stylecode from product where serial = #{serial}) and not serial = #{serial}
</select>


</mapper>